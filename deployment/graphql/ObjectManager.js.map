{"version":3,"sources":["../../graphql/ObjectManager.js"],"names":["User_0","id","uuidNull","UserToken2","User_DisplayName","entityDefinitions","setPersisters","Set","deletedRecord","deleted","ObjectManager","loadersSingle","loadersMultiple","changes","Viewer_User_id","request","req","res","response","siteInformation","entityName","foundLoaders","fields","isDeletion","records","Error","fieldName","multipleResults","entityDefinition","entityType","EntityType","loadersList","getLoadersMultiple","getLoadersSingle","loader","Persister","getObjectList","filter","getOneObject","uuidNullAsString","Promise","resolve","loaderIdentifier","Object","keys","sort","join","getLoader","load","then","change","result","ix","arrResults","length","splice","clearLoadersMultiple","loaderFieldName","clear","arrTriggers","oldFields","arrPromises","trigger","push","all","console","log","uuidRandom","setViewerUserId","toString","recordChange","executeTriggers","TriggersForAdd","add","invalidateLoaderCache","TriggersForUpdateShouldRetrieveCurrentRecord","TriggersForUpdate","update","keyFields","ensureFields","entity","ensuredFieldName","isMatchingValue","endsWith","uuidToString","site_id","uuidEquals","TriggersForRemove","remove","arr","obj","obj_id","arr_element_id","cursor","persister","EntityName","handler","shouldRetrieveCurrentRecord","RegisterTriggerForAdd","RegisterTriggerForUpdate","runAsPartOfSetupDatabase","cb","initialize","registerEntity"],"mappings":"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","file":"ObjectManager.js","sourcesContent":["// @flow\n\nimport DataLoader from 'dataloader'\nimport { cursorForObjectInConnection } from 'graphql-relay'\n\nimport AnonymousUserToken2 from '../configuration/server/AnonymousUserToken2'\nimport defaultPersister from '../configuration/graphql/defaultPersister'\nimport getNewUser from '../configuration/graphql/model/getNewUser'\nimport log from '../server/log'\nimport User from '../configuration/graphql/model/User'\n\n// Anonymous user\nconst User_0 = new User(\n  Object.assign(getNewUser('00000000-0000-0000-0000-000000000000'), {\n    id: defaultPersister.uuidNull(),\n    UserToken2: AnonymousUserToken2,\n    User_DisplayName: 'Anonymous',\n  }),\n)\n\n// Static set of entity definitions\nconst entityDefinitions = {}\n\n// Static array of object managers\nconst setPersisters = new Set()\n\n// Value for a change indicating that the record is deleted\nconst deletedRecord = {\n  deleted: true,\n}\n\nexport default class ObjectManager {\n  loadersSingle: Object\n  Viewer_User_id: ?string\n  loadersMultiple: Object\n  changes: Object\n  request: ?Object\n  response: ?Object\n  User_0: User\n  siteInformation: ?Object\n\n  constructor() {\n    // Loaders for a single record, by entity name\n    this.loadersSingle = {}\n\n    // Loaders for a multiple record lists, by entity name\n    this.loadersMultiple = {}\n\n    // Changes made to records, by entity name\n    this.changes = {}\n\n    // UserID for the viewer. Could be unset if ObjectManager is used by system\n    this.Viewer_User_id = null\n\n    // Request object, if available\n    this.request = null\n\n    // Anonymous user available as property, for comparisons\n    this.User_0 = User_0\n  }\n\n  static registerEntity(entityName: string, EntityType: any, persister: any): void {\n    if (entityName in entityDefinitions) throw new Error('Entity already registered: ' + entityName)\n\n    // In order to be able to access the name as a static property of the type\n    EntityType.entityName = entityName\n\n    // Determine persister - default, or otherwise\n    if (persister == null) persister = defaultPersister\n\n    // A set would retain only one copy of a persister\n    setPersisters.add(persister)\n\n    entityDefinitions[entityName] = {\n      EntityName: entityName,\n      EntityType: EntityType,\n      Persister: persister,\n      TriggersForAdd: [],\n      TriggersForUpdate: [],\n      TriggersForRemove: [],\n      TriggersForUpdateShouldRetrieveCurrentRecord: false,\n    }\n  }\n\n  static RegisterTriggerForAdd(entityName: string, handler: Function): void {\n    entityDefinitions[entityName].TriggersForAdd.push(handler)\n  }\n\n  static RegisterTriggerForUpdate(\n    entityName: string,\n    handler: Function,\n    shouldRetrieveCurrentRecord: boolean,\n  ): void {\n    entityDefinitions[entityName].TriggersForUpdate.push(handler)\n\n    if (shouldRetrieveCurrentRecord)\n      entityDefinitions[entityName].TriggersForUpdateShouldRetrieveCurrentRecord = true\n  }\n\n  static RegisterTriggerForAddAndUpdate(entityName: string, handler: Function): void {\n    ObjectManager.RegisterTriggerForAdd(entityName, handler)\n    ObjectManager.RegisterTriggerForUpdate(entityName, handler, false)\n  }\n\n  static RegisterTriggerForRemove(entityName: string, handler: any) {\n    entityDefinitions[entityName].TriggersForRemove.push(handler)\n  }\n\n  setViewerUserId(Viewer_User_id: string): void {\n    this.Viewer_User_id = Viewer_User_id\n  }\n\n  setRequest(req: any, res: any): void {\n    this.request = req\n    this.response = res\n  }\n\n  setSiteInformation(siteInformation: Object): void {\n    this.siteInformation = siteInformation\n  }\n\n  getLoadersSingle(entityName: string) {\n    const foundLoaders = this.loadersSingle[entityName]\n    if (foundLoaders != null) return foundLoaders\n    else return (this.loadersSingle[entityName] = {})\n  }\n\n  getLoadersMultiple(entityName: string) {\n    const foundLoaders = this.loadersMultiple[entityName]\n    if (foundLoaders != null) return foundLoaders\n    else return (this.loadersMultiple[entityName] = {})\n  }\n\n  clearLoadersMultiple(entityName: string) {\n    this.loadersMultiple[entityName] = {}\n  }\n\n  recordChange(entityName: string, fields: Object, isDeletion: boolean) {\n    let records = this.changes[entityName]\n    if (records == null) records = this.changes[entityName] = {}\n\n    const id = fields.id\n\n    records[id] = isDeletion ? deletedRecord : fields\n  }\n\n  getViewerUserId(): string {\n    if (this.Viewer_User_id == null)\n      throw new Error('Object Manager: viewer user id has not been set')\n\n    return this.Viewer_User_id\n  }\n\n  getRequest(): any {\n    if (this.request == null) throw new Error('Object Manager: request has not been set')\n\n    return this.request\n  }\n\n  getLoader(entityName: string, fieldName: string, multipleResults: boolean) {\n    if (!(entityName in entityDefinitions))\n      throw new Error('Can not find entity type named ' + entityName)\n\n    const entityDefinition = entityDefinitions[entityName]\n    const entityType = entityDefinition.EntityType\n\n    let loadersList = multipleResults\n      ? this.getLoadersMultiple(entityName)\n      : this.getLoadersSingle(entityName)\n    let loader = loadersList[fieldName]\n    if (loader == null) {\n      if (multipleResults)\n        loader = new DataLoader(filter =>\n          entityDefinition.Persister.getObjectList(entityName, entityType, filter),\n        )\n      else\n        loader = new DataLoader(filter =>\n          entityDefinition.Persister.getOneObject(entityName, entityType, filter),\n        )\n\n      loadersList[fieldName] = loader\n    }\n\n    return loader\n  }\n\n  getOneObject(entityName: string, filter: Object) {\n    // TODO x2000 Provide try catch with logging here!\n    // Special hack for anonymous users\n    if (entityName == 'User')\n      if (filter.id == defaultPersister.uuidNullAsString()) return Promise.resolve(User_0)\n\n    // For all non-user, non 0 ids, load from data loader per protocol\n    const loaderIdentifier = Object.keys(filter).sort().join(',')\n    const loader = this.getLoader(entityName, loaderIdentifier, false)\n\n    return loader.load(filter).then(result => {\n      const changes = this.changes[entityName]\n      if (changes) {\n        const change = changes[result.id]\n        if (change != null) {\n          if (change === deletedRecord)\n            result = null // Object is not found, return null // Add or update\n          else Object.assign(result, change)\n        }\n      }\n      return result\n    })\n  }\n\n  getObjectList(entityName: string, filter: object) {\n    // TODO x2000 Provide try catch with logging here!\n    const loaderIdentifier = Object.keys(filter).sort().join(',')\n    const loader = this.getLoader(entityName, loaderIdentifier, true)\n\n    return loader.load(filter).then(arrResults => {\n      const changes = this.changes[entityName]\n      if (changes) {\n        for (let ix = 0; ix < arrResults.length; ix++) {\n          const change = changes[arrResults[ix].id]\n          if (change != null) {\n            if (change === deletedRecord)\n              arrResults.splice(ix--, 1) // Reduce ix in order not to skip over a record // Add or update\n            else Object.assign(arrResults[ix], change)\n          }\n        }\n      }\n      return arrResults\n    })\n  }\n\n  invalidateLoaderCache(entityName: string, fields: any) {\n    // At this moment there is no obvious way of knowing what to clear from lists, so delete them all\n    this.clearLoadersMultiple(entityName)\n\n    const loadersSingle = this.getLoadersSingle(entityName)\n    for (let loaderFieldName in loadersSingle) {\n      if (loaderFieldName === 'id') loadersSingle[loaderFieldName].clear(fields.id)\n      else delete loadersSingle[loaderFieldName]\n    }\n  }\n\n  executeTriggers(arrTriggers: Array<Function>, fields: Object, oldFields: Object) {\n    const arrPromises = []\n    for (let trigger of arrTriggers) {\n      arrPromises.push(trigger(this, fields, oldFields))\n    }\n\n    return Promise.all(arrPromises)\n  }\n\n  async add(entityName: string, fields: any): any {\n    const entityDefinition = entityDefinitions[entityName]\n\n    if (entityDefinition == null) console.log('Cound not find entity ' + entityName)\n\n    // Generate primary key, if not already present\n    if (!fields.id) fields.id = entityDefinition.Persister.uuidRandom()\n\n    // If this is a user ID\n    if (entityName == 'User') this.setViewerUserId(fields.id.toString())\n\n    this.recordChange(entityName, fields, false)\n    await this.executeTriggers(entityDefinition.TriggersForAdd, fields)\n\n    await entityDefinition.Persister.add(entityName, fields, entityDefinition.EntityType)\n\n    this.invalidateLoaderCache(entityName, fields)\n\n    return fields.id\n  }\n\n  async update(entityName: string, fields: any): Promise<void> {\n    const entityDefinition = entityDefinitions[entityName]\n\n    if (entityDefinition == null) console.log('üíî  XXX Cound not find entity' + entityName) // Should that be recorded somewhere? Could be another\n\n    let oldFields = null\n    if (entityDefinition.TriggersForUpdateShouldRetrieveCurrentRecord) {\n      oldFields = this.getOneObject(entityName, {\n        id: fields.id,\n      })\n    }\n\n    this.recordChange(entityName, fields, false)\n    await this.executeTriggers(entityDefinition.TriggersForUpdate, fields, oldFields)\n\n    await entityDefinition.Persister.update(entityName, fields)\n\n    this.invalidateLoaderCache(entityName, fields)\n  }\n\n  async ensure(entityName: string, keyFields: Object, ensureFields: Object): Promise<Object> {\n    const entityDefinition = entityDefinitions[entityName]\n\n    const entity = await this.getOneObject(entityName, keyFields)\n    console.log(entity)\n    console.log(ensureFields)\n\n    for (let ensuredFieldName of Object.keys(ensureFields)) {\n      let isMatchingValue = false\n      if (ensuredFieldName.endsWith('site_id'))\n        isMatchingValue =\n          entityDefinition.Persister.uuidToString(entity.site_id) == ensureFields.site_id\n      else if (ensuredFieldName.endsWith('_id'))\n        isMatchingValue = entityDefinition.Persister.uuidEquals(\n          ensureFields[ensuredFieldName],\n          entity[ensuredFieldName],\n        )\n      else isMatchingValue = ensureFields[ensuredFieldName] == entity[ensuredFieldName]\n\n      if (!isMatchingValue)\n        throw new Error(\n          'üíî  Field value can not be ensured for field ' + ensuredFieldName + ' of ' + entityName,\n        )\n    }\n\n    return entity\n  }\n\n  async remove(entityName: string, fields: Object): Promise<void> {\n    const entityDefinition = entityDefinitions[entityName]\n\n    this.recordChange(entityName, fields, true)\n    await this.executeTriggers(entityDefinition.TriggersForRemove, fields)\n\n    await entityDefinition.Persister.remove(entityName, fields)\n\n    this.invalidateLoaderCache(entityName, fields)\n  }\n\n  cursorForObjectInConnection(entityName: string, arr, obj) {\n    const entityDefinition = entityDefinitions[entityName]\n\n    // IDs can be both strings and Uuid. Check that first, and convert to String\n    const obj_id = entityDefinition.Persister.uuidToString(obj.id)\n\n    // Make sure that the object and its instance can be compared with ===\n    // assumed that the object has id field which is unique\n    for (let ix = 0; ix < arr.length; ix++) {\n      const arr_element_id = entityDefinition.Persister.uuidToString(arr[ix].id)\n\n      if (arr_element_id == obj_id) {\n        arr[ix] = obj\n        break\n      }\n    }\n\n    let cursor = cursorForObjectInConnection(arr, obj)\n    if (cursor == null)\n      log.log('error', 'üíî  Could not create cursor for object in connection for ' + entityName, {\n        obj,\n        arr,\n      })\n\n    return cursor\n  }\n\n  static initializePersisters(runAsPartOfSetupDatabase: boolean, cb: Function): void {\n    console.log('üöÄ Initializing persisters - start ...')\n\n    // TODO x8000 This should be re-done to work properly with more than one persister\n    for (let persister of setPersisters)\n      persister.initialize(runAsPartOfSetupDatabase, () => {\n        console.log('üèÜ Initializing persisters - success.')\n        cb()\n      })\n  }\n}\n\nObjectManager.registerEntity('User', User)\n"]}