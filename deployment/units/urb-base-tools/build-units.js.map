{"version":3,"sources":["../../../units/urb-base-tools/build-units.js"],"names":["existsAsync","exists","readFileAsync","readFile","readdirAsync","readdir","sortObject","object","t","Object","keys","sort","forEach","k","orderPackages","packageAsObject","scripts","dependencies","devDependencies","mergeScripts","scripts1","scripts2","scriptName","script","script2","createPackageJson","units","packageJsonFileName","resolve","currentPackageAsJSONString","toString","currentPackageAsObject","JSON","parse","engines","name","version","unitName","packageAsObjectName","packageToAddAsObject","stringify","createMutations","mutationsImports","mutationsExports","endsWith","mutationsDir","mutationFileNames","mutationFileName","mutation","substring","length","push","replace","mutations","concat","join","createSchemas","schemasImports","schemasDir","objectTypeFileNames","objectTypeFileName","objectType","schemas","createViewerFields","viewerFieldsImports","viewerFieldsExports","viewerFieldsFileName","viewerFieldsImportName","viewerFields","createRoutes","routesImports","routesExports","routesDir","routeFileNames","routeFileName","startsWith","route","routes","getUnits","fileName","filter","main","taskPromises","Promise","all","then","console","log"],"mappings":"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","file":"build-units.js","sourcesContent":["// @flow\n\nimport fs from 'fs'\nimport path from 'path'\nimport { promisify } from 'util'\n\nimport ensureFileContent from './ensureFileContent'\n\nconst existsAsync = promisify( fs.exists )\nconst readFileAsync = promisify( fs.readFile )\nconst readdirAsync = promisify( fs.readdir )\n\nfunction sortObject( object: Object ) {\n  var t = {}\n  Object.keys( object ).sort().forEach( function( k ) {\n    t[k] = object[k]\n  })\n  return t\n}\n\nfunction orderPackages( packageAsObject ) {\n  packageAsObject.scripts = sortObject( packageAsObject.scripts )\n  packageAsObject.dependencies = sortObject( packageAsObject.dependencies )\n  packageAsObject.devDependencies = sortObject( packageAsObject.devDependencies )\n}\n\nfunction mergeScripts( scripts1, scripts2 ) {\n  const scripts = Object.assign({}, scripts1 )\n\n  for ( let scriptName in scripts2 ) {\n    const script = scripts[scriptName]\n    const script2 = scripts2[scriptName]\n\n    if ( script && script2 ) {\n      scripts[scriptName] = script + ' && ' + script2\n    } else if ( script2 ) {\n      scripts[scriptName] = script2\n    }\n  }\n\n  return scripts\n}\n\nasync function createPackageJson( units: Array<string> ) {\n  const packageJsonFileName = path.resolve( './package.json' )\n  const currentPackageAsJSONString = ( await readFileAsync(\n    packageJsonFileName\n  ) ).toString()\n  const currentPackageAsObject = JSON.parse( currentPackageAsJSONString )\n  const packageAsObject = {\n    dependencies: {},\n    devDependencies: {},\n    engines: {},\n    name: null,\n    'lint-staged': {},\n    scripts: {},\n    version: null,\n  }\n\n  // Make sure not to overwrite version information\n  packageAsObject.version = currentPackageAsObject.version\n  packageAsObject.name = currentPackageAsObject.name\n\n  // Add packages to object\n  for ( let unitName of units ) {\n    const packageAsObjectName = path.resolve(\n      './units',\n      unitName,\n      'package.part.json'\n    )\n    if ( await existsAsync( packageAsObjectName ) ) {\n      const packageToAddAsObject = JSON.parse(\n        ( await readFileAsync( packageAsObjectName ) ).toString()\n      )\n\n      if ( packageToAddAsObject.dependencies )\n        Object.assign(\n          packageAsObject.dependencies,\n          packageToAddAsObject.dependencies\n        )\n      if ( packageToAddAsObject.devDependencies )\n        Object.assign(\n          packageAsObject.devDependencies,\n          packageToAddAsObject.devDependencies\n        )\n      if ( packageToAddAsObject.engines )\n        Object.assign( packageAsObject.engines, packageToAddAsObject.engines )\n      if ( packageToAddAsObject['lint-staged'])\n        Object.assign(\n          packageAsObject['lint-staged'],\n          packageToAddAsObject['lint-staged']\n        )\n      if ( packageToAddAsObject.scripts )\n        packageAsObject.scripts = mergeScripts(\n          packageAsObject.scripts,\n          packageToAddAsObject.scripts\n        )\n    }\n  }\n\n  // Make them pretty\n  orderPackages( packageAsObject )\n\n  await ensureFileContent(\n    packageJsonFileName,\n    currentPackageAsJSONString,\n    JSON.stringify( packageAsObject, null, 2 )\n  )\n}\n\nasync function createMutations( units: Array<string> ) {\n  const mutationsImports = []\n  const mutationsExports = []\n\n  for ( let unitName of units )\n    if ( unitName.endsWith( '-server' ) ) {\n      const mutationsDir = path.resolve( './units', unitName, 'graphql/mutation' )\n      if ( await existsAsync( mutationsDir ) ) {\n        const mutationFileNames = await readdirAsync( mutationsDir )\n\n        for ( let mutationFileName of mutationFileNames ) {\n          if ( mutationFileName.endsWith( '.js' ) ) {\n            const mutation = mutationFileName.substring(\n              0,\n              mutationFileName.length - 3\n            )\n            mutationsImports.push(\n              'import ' +\n                mutation.replace( '.', '_' ) +\n                ' from \\'../../../' +\n                unitName +\n                '/graphql/mutation/' +\n                mutation +\n                '\\''\n            )\n            mutationsExports.push( '  ' + mutation + ',' )\n          }\n        }\n      }\n    }\n\n  let mutations = [ '// @flow', '' ]\n  mutations = mutations.concat( mutationsImports )\n  mutations = mutations.concat([ '', 'export default {' ])\n  mutations = mutations.concat( mutationsExports )\n  mutations = mutations.concat([ '}' ])\n\n  await ensureFileContent(\n    path.resolve(\n      './units/_configuration/urb-base-server/graphql/_mutations.js'\n    ),\n    null,\n    mutations.join( '\\r\\n' )\n  )\n}\n\nasync function createSchemas( units: Array<string> ) {\n  const schemasImports = []\n\n  for ( let unitName of units )\n    if ( unitName.endsWith( '-server' ) ) {\n      const schemasDir = path.resolve( './units', unitName, 'graphql/model' )\n      if ( await existsAsync( schemasDir ) ) {\n        const objectTypeFileNames = await readdirAsync( schemasDir )\n\n        for ( let objectTypeFileName of objectTypeFileNames ) {\n          if ( objectTypeFileName.endsWith( '.js' ) ) {\n            const objectType = objectTypeFileName.substring(\n              0,\n              objectTypeFileName.length - 3\n            )\n            schemasImports.push(\n              'import \\'../../../' +\n                unitName +\n                '/graphql/model/' +\n                objectType +\n                '\\''\n            )\n          }\n        }\n      }\n    }\n\n  let schemas = [ '// @flow', '' ]\n  schemas = schemas.concat( schemasImports )\n  schemas = schemas.concat([ '', 'export default true' ])\n\n  await ensureFileContent(\n    path.resolve( './units/_configuration/urb-base-server/graphql/_schemas.js' ),\n    null,\n    schemas.join( '\\r\\n' )\n  )\n}\n\nasync function createViewerFields( units: Array<string> ) {\n  const viewerFieldsImports = []\n  const viewerFieldsExports = []\n\n  for ( let unitName of units )\n    if ( unitName.endsWith( '-server' ) ) {\n      const viewerFieldsFileName = path.resolve(\n        './units',\n        unitName,\n        'graphql/type/_ViewerFields.js'\n      )\n      if ( await existsAsync( viewerFieldsFileName ) ) {\n        const viewerFieldsImportName = unitName.replace( /-/g, '_' )\n        viewerFieldsImports.push(\n          'import ' +\n            viewerFieldsImportName +\n            ' from \\'../../../' +\n            unitName +\n            '/graphql/type/_ViewerFields\\''\n        )\n        viewerFieldsExports.push( '  ...' + viewerFieldsImportName + ',' )\n      }\n    }\n\n  let viewerFields = [ '// @flow', '' ]\n  viewerFields = viewerFields.concat( viewerFieldsImports )\n  viewerFields = viewerFields.concat([ '', 'export default {' ])\n  viewerFields = viewerFields.concat( viewerFieldsExports )\n  viewerFields = viewerFields.concat([ '}' ])\n\n  await ensureFileContent(\n    path.resolve(\n      './units/_configuration/urb-base-server/graphql/_ViewerFields.js'\n    ),\n    null,\n    viewerFields.join( '\\r\\n' )\n  )\n}\n\nasync function createRoutes( units: Array<string> ) {\n  const routesImports = []\n  const routesExports = []\n\n  for ( let unitName of units )\n    if ( unitName.endsWith( '-webapp' ) ) {\n      const routesDir = path.resolve( './units', unitName )\n      if ( await existsAsync( routesDir ) ) {\n        const routeFileNames = await readdirAsync( routesDir )\n\n        for ( let routeFileName of routeFileNames ) {\n          if (\n            routeFileName.endsWith( '.jsx' ) &&\n            routeFileName.startsWith( 'routeAppFrame' )\n          ) {\n            const route = routeFileName.substring( 0, routeFileName.length - 4 )\n            routesImports.push(\n              'import ' + route + ' from \\'../../' + unitName + '/' + route + '\\''\n            )\n            routesExports.push( '  ' + route + ',' )\n          }\n        }\n      }\n    }\n\n  let routes = [ '// @flow', '' ]\n  routes = routes.concat( routesImports )\n  routes = routes.concat([ '', 'export default [' ])\n  routes = routes.concat( routesExports )\n  routes = routes.concat([ ']' ])\n\n  await ensureFileContent(\n    path.resolve( './units/_configuration/urb-base-webapp/routesAppFrame.js' ),\n    null,\n    routes.join( '\\r\\n' )\n  )\n}\n\nasync function getUnits() {\n  const units = ( await readdirAsync( './units/' ) ).filter(\n    fileName => fileName !== '.DS_Store' && fileName !== '_configuration'\n  )\n  return units\n}\n\nasync function main() {\n  const units = await getUnits()\n\n  const taskPromises = [\n    createPackageJson( units ),\n    createViewerFields( units ),\n    createSchemas( units ),\n    createMutations( units ),\n    createRoutes( units ),\n  ]\n\n  await Promise.all( taskPromises )\n}\n\nmain().then( () => console.log( 'Fin.' ) )\n"]}