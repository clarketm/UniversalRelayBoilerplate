{"version":3,"sources":["../../../../units/urb-base-server/graphql/ObjectManager.js"],"names":["getObjectManager","User_0","id","uuidNull","UserToken2","User_DisplayName","entityDefinitions","setPersisters","Set","deletedRecord","deleted","ObjectManager","loadersSingle","loadersMultiple","changes","Viewer_User_id","request","req","res","response","siteInformation","entityName","foundLoaders","fields","isDeletion","records","Error","fieldName","multipleResults","entityDefinition","entityType","EntityType","loadersList","getLoadersMultiple","getLoadersSingle","loader","Persister","getObjectList","filter","getOneObject","uuidNullAsString","Promise","resolve","loaderIdentifier","Object","keys","sort","join","getLoader","load","then","change","result","ix","arrResults","length","splice","clearLoadersMultiple","loaderFieldName","clear","arrTriggers","oldFields","arrPromises","trigger","push","all","console","log","uuidRandom","setViewerUserId","toString","recordChange","executeTriggers","TriggersForAdd","add","invalidateLoaderCache","TriggersForUpdateShouldRetrieveCurrentRecord","TriggersForUpdate","update","keyFields","ensureFields","entity","ensuredFieldName","isMatchingValue","endsWith","uuidToString","site_id","uuidEquals","TriggersForRemove","remove","arr","obj","obj_id","arr_element_id","cursor","persister","EntityName","handler","shouldRetrieveCurrentRecord","RegisterTriggerForAdd","RegisterTriggerForUpdate","runAsPartOfSetupDatabase","cb","initialize","registerEntity","objectManager","setRequest","setSiteInformation"],"mappings":"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","file":"ObjectManager.js","sourcesContent":["// @flow\n\nimport DataLoader from 'dataloader'\nimport { cursorForObjectInConnection } from 'graphql-relay'\n\nimport AnonymousUserToken2 from '../../../configuration/urb-base-server/AnonymousUserToken2'\nimport defaultPersister from '../../../configuration/urb-base-server/graphql/defaultPersister'\nimport getNewUser from '../../../configuration/urb-base-server/graphql/model/getNewUser'\nimport { getSiteInformation } from '../../../configuration/urb-base-webapp/siteSettings'\nimport log from '../log'\nimport User from '../../../configuration/urb-base-server/graphql/model/User'\n\n// Anonymous user\nconst User_0 = new User(\n  Object.assign(getNewUser('00000000-0000-0000-0000-000000000000'), {\n    id: defaultPersister.uuidNull(),\n    UserToken2: AnonymousUserToken2,\n    User_DisplayName: 'Anonymous',\n  }),\n)\n\n// Static set of entity definitions\nconst entityDefinitions = {}\n\n// Static array of object managers\nconst setPersisters = new Set()\n\n// Value for a change indicating that the record is deleted\nconst deletedRecord = {\n  deleted: true,\n}\n\nexport default class ObjectManager {\n  loadersSingle: Object\n  Viewer_User_id: ?string\n  loadersMultiple: Object\n  changes: Object\n  request: ?Object\n  response: ?Object\n  User_0: User\n  siteInformation: ?Object\n\n  constructor() {\n    // Loaders for a single record, by entity name\n    this.loadersSingle = {}\n\n    // Loaders for a multiple record lists, by entity name\n    this.loadersMultiple = {}\n\n    // Changes made to records, by entity name\n    this.changes = {}\n\n    // UserID for the viewer. Could be unset if ObjectManager is used by system\n    this.Viewer_User_id = null\n\n    // Request object, if available\n    this.request = null\n\n    // Anonymous user available as property, for comparisons\n    this.User_0 = User_0\n  }\n\n  static registerEntity(entityName: string, EntityType: any, persister: any): void {\n    if (entityName in entityDefinitions) throw new Error('Entity already registered: ' + entityName)\n\n    // In order to be able to access the name as a static property of the type\n    EntityType.entityName = entityName\n\n    // Determine persister - default, or otherwise\n    if (persister == null) persister = defaultPersister\n\n    // A set would retain only one copy of a persister\n    setPersisters.add(persister)\n\n    entityDefinitions[entityName] = {\n      EntityName: entityName,\n      EntityType: EntityType,\n      Persister: persister,\n      TriggersForAdd: [],\n      TriggersForUpdate: [],\n      TriggersForRemove: [],\n      TriggersForUpdateShouldRetrieveCurrentRecord: false,\n    }\n  }\n\n  static RegisterTriggerForAdd(entityName: string, handler: Function): void {\n    entityDefinitions[entityName].TriggersForAdd.push(handler)\n  }\n\n  static RegisterTriggerForUpdate(\n    entityName: string,\n    handler: Function,\n    shouldRetrieveCurrentRecord: boolean,\n  ): void {\n    entityDefinitions[entityName].TriggersForUpdate.push(handler)\n\n    if (shouldRetrieveCurrentRecord)\n      entityDefinitions[entityName].TriggersForUpdateShouldRetrieveCurrentRecord = true\n  }\n\n  static RegisterTriggerForAddAndUpdate(entityName: string, handler: Function): void {\n    ObjectManager.RegisterTriggerForAdd(entityName, handler)\n    ObjectManager.RegisterTriggerForUpdate(entityName, handler, false)\n  }\n\n  static RegisterTriggerForRemove(entityName: string, handler: any) {\n    entityDefinitions[entityName].TriggersForRemove.push(handler)\n  }\n\n  setViewerUserId(Viewer_User_id: string): void {\n    this.Viewer_User_id = Viewer_User_id\n  }\n\n  setRequest(req: any, res: any): void {\n    this.request = req\n    this.response = res\n  }\n\n  setSiteInformation(siteInformation: Object): void {\n    this.siteInformation = siteInformation\n  }\n\n  getLoadersSingle(entityName: string) {\n    const foundLoaders = this.loadersSingle[entityName]\n    if (foundLoaders != null) return foundLoaders\n    else return (this.loadersSingle[entityName] = {})\n  }\n\n  getLoadersMultiple(entityName: string) {\n    const foundLoaders = this.loadersMultiple[entityName]\n    if (foundLoaders != null) return foundLoaders\n    else return (this.loadersMultiple[entityName] = {})\n  }\n\n  clearLoadersMultiple(entityName: string) {\n    this.loadersMultiple[entityName] = {}\n  }\n\n  recordChange(entityName: string, fields: Object, isDeletion: boolean) {\n    let records = this.changes[entityName]\n    if (records == null) records = this.changes[entityName] = {}\n\n    const id = fields.id\n\n    records[id] = isDeletion ? deletedRecord : fields\n  }\n\n  getViewerUserId(): string {\n    if (this.Viewer_User_id == null)\n      throw new Error('Object Manager: viewer user id has not been set')\n\n    return this.Viewer_User_id\n  }\n\n  getRequest(): any {\n    if (this.request == null) throw new Error('Object Manager: request has not been set')\n\n    return this.request\n  }\n\n  getLoader(entityName: string, fieldName: string, multipleResults: boolean) {\n    if (!(entityName in entityDefinitions))\n      throw new Error('Can not find entity type named ' + entityName)\n\n    const entityDefinition = entityDefinitions[entityName]\n    const entityType = entityDefinition.EntityType\n\n    let loadersList = multipleResults\n      ? this.getLoadersMultiple(entityName)\n      : this.getLoadersSingle(entityName)\n    let loader = loadersList[fieldName]\n    if (loader == null) {\n      if (multipleResults)\n        loader = new DataLoader(filter =>\n          entityDefinition.Persister.getObjectList(entityName, entityType, filter),\n        )\n      else\n        loader = new DataLoader(filter =>\n          entityDefinition.Persister.getOneObject(entityName, entityType, filter),\n        )\n\n      loadersList[fieldName] = loader\n    }\n\n    return loader\n  }\n\n  getOneObject(entityName: string, filter: Object) {\n    // TODO x2000 Provide try catch with logging here!\n    // Special hack for anonymous users\n    if (entityName == 'User')\n      if (filter.id == defaultPersister.uuidNullAsString()) return Promise.resolve(User_0)\n\n    // For all non-user, non 0 ids, load from data loader per protocol\n    const loaderIdentifier = Object.keys(filter).sort().join(',')\n    const loader = this.getLoader(entityName, loaderIdentifier, false)\n\n    return loader.load(filter).then(result => {\n      const changes = this.changes[entityName]\n      if (changes) {\n        const change = changes[result.id]\n        if (change != null) {\n          if (change === deletedRecord)\n            result = null // Object is not found, return null // Add or update\n          else Object.assign(result, change)\n        }\n      }\n      return result\n    })\n  }\n\n  getObjectList(entityName: string, filter: Object) {\n    // TODO x2000 Provide try catch with logging here!\n    const loaderIdentifier = Object.keys(filter).sort().join(',')\n    const loader = this.getLoader(entityName, loaderIdentifier, true)\n\n    return loader.load(filter).then(arrResults => {\n      const changes = this.changes[entityName]\n      if (changes) {\n        for (let ix = 0; ix < arrResults.length; ix++) {\n          const change = changes[arrResults[ix].id]\n          if (change != null) {\n            if (change === deletedRecord)\n              arrResults.splice(ix--, 1) // Reduce ix in order not to skip over a record // Add or update\n            else Object.assign(arrResults[ix], change)\n          }\n        }\n      }\n      return arrResults\n    })\n  }\n\n  invalidateLoaderCache(entityName: string, fields: any) {\n    // At this moment there is no obvious way of knowing what to clear from lists, so delete them all\n    this.clearLoadersMultiple(entityName)\n\n    const loadersSingle = this.getLoadersSingle(entityName)\n    for (let loaderFieldName in loadersSingle) {\n      if (loaderFieldName === 'id') loadersSingle[loaderFieldName].clear(fields.id)\n      else delete loadersSingle[loaderFieldName]\n    }\n  }\n\n  executeTriggers(arrTriggers: Array<Function>, fields: Object, oldFields: Object) {\n    const arrPromises = []\n    for (let trigger of arrTriggers) {\n      arrPromises.push(trigger(this, fields, oldFields))\n    }\n\n    return Promise.all(arrPromises)\n  }\n\n  async add(entityName: string, fields: any): any {\n    const entityDefinition = entityDefinitions[entityName]\n\n    if (entityDefinition == null) console.log('Cound not find entity ' + entityName)\n\n    // Generate primary key, if not already present\n    if (!fields.id) fields.id = entityDefinition.Persister.uuidRandom()\n\n    // If this is a user ID\n    if (entityName == 'User') this.setViewerUserId(fields.id.toString())\n\n    this.recordChange(entityName, fields, false)\n    await this.executeTriggers(entityDefinition.TriggersForAdd, fields)\n\n    await entityDefinition.Persister.add(entityName, fields, entityDefinition.EntityType)\n\n    this.invalidateLoaderCache(entityName, fields)\n\n    return fields.id\n  }\n\n  async update(entityName: string, fields: any): Promise<void> {\n    const entityDefinition = entityDefinitions[entityName]\n\n    if (entityDefinition == null) console.log('üíî  XXX Cound not find entity' + entityName) // Should that be recorded somewhere? Could be another\n\n    let oldFields = null\n    if (entityDefinition.TriggersForUpdateShouldRetrieveCurrentRecord) {\n      oldFields = this.getOneObject(entityName, {\n        id: fields.id,\n      })\n    }\n\n    this.recordChange(entityName, fields, false)\n    await this.executeTriggers(entityDefinition.TriggersForUpdate, fields, oldFields)\n\n    await entityDefinition.Persister.update(entityName, fields)\n\n    this.invalidateLoaderCache(entityName, fields)\n  }\n\n  async ensure(entityName: string, keyFields: Object, ensureFields: Object): Promise<Object> {\n    const entityDefinition = entityDefinitions[entityName]\n\n    const entity = await this.getOneObject(entityName, keyFields)\n    console.log(entity)\n    console.log(ensureFields)\n\n    for (let ensuredFieldName of Object.keys(ensureFields)) {\n      let isMatchingValue = false\n      if (ensuredFieldName.endsWith('site_id'))\n        isMatchingValue =\n          entityDefinition.Persister.uuidToString(entity.site_id) == ensureFields.site_id\n      else if (ensuredFieldName.endsWith('_id'))\n        isMatchingValue = entityDefinition.Persister.uuidEquals(\n          ensureFields[ensuredFieldName],\n          entity[ensuredFieldName],\n        )\n      else isMatchingValue = ensureFields[ensuredFieldName] == entity[ensuredFieldName]\n\n      if (!isMatchingValue)\n        throw new Error(\n          'üíî  Field value can not be ensured for field ' + ensuredFieldName + ' of ' + entityName,\n        )\n    }\n\n    return entity\n  }\n\n  async remove(entityName: string, fields: Object): Promise<void> {\n    const entityDefinition = entityDefinitions[entityName]\n\n    this.recordChange(entityName, fields, true)\n    await this.executeTriggers(entityDefinition.TriggersForRemove, fields)\n\n    await entityDefinition.Persister.remove(entityName, fields)\n\n    this.invalidateLoaderCache(entityName, fields)\n  }\n\n  cursorForObjectInConnection(entityName: string, arr, obj) {\n    const entityDefinition = entityDefinitions[entityName]\n\n    // IDs can be both strings and Uuid. Check that first, and convert to String\n    const obj_id = entityDefinition.Persister.uuidToString(obj.id)\n\n    // Make sure that the object and its instance can be compared with ===\n    // assumed that the object has id field which is unique\n    for (let ix = 0; ix < arr.length; ix++) {\n      const arr_element_id = entityDefinition.Persister.uuidToString(arr[ix].id)\n\n      if (arr_element_id == obj_id) {\n        arr[ix] = obj\n        break\n      }\n    }\n\n    let cursor = cursorForObjectInConnection(arr, obj)\n    if (cursor == null)\n      log.log('error', 'üíî  Could not create cursor for object in connection for ' + entityName, {\n        obj,\n        arr,\n      })\n\n    return cursor\n  }\n\n  static initializePersisters(runAsPartOfSetupDatabase: boolean, cb: Function): void {\n    console.log('üöÄ Initializing persisters - start ...')\n\n    // TODO x8000 This should be re-done to work properly with more than one persister\n    for (let persister of setPersisters)\n      persister.initialize(runAsPartOfSetupDatabase, () => {\n        console.log('üèÜ Initializing persisters - success.')\n        cb()\n      })\n  }\n}\n\n// Register the user\nObjectManager.registerEntity('User', User)\n\n// Get an Object Manager with site information\nexport async function getObjectManager(req: Object, res: Object) {\n  // Set site information\n  const siteInformation = await getSiteInformation(req, res)\n\n  // Create individual object manager for each request\n  const objectManager = new ObjectManager()\n\n  // Set request and response\n  objectManager.setRequest(req, res)\n\n  // Place site builder configuration into object manager\n  objectManager.setSiteInformation(siteInformation)\n\n  return objectManager\n}\n"]}